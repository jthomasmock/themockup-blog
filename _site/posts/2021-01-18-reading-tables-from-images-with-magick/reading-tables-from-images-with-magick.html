<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.294">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Thomas Mock">
<meta name="description" content="magick is an R package for manipulating images in R">
<title>The MockUp - Reading tables from images with magick</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<script src="../../site_libs/quarto-nav/quarto-nav.js"></script><script src="../../site_libs/quarto-nav/headroom.min.js"></script><script src="../../site_libs/clipboard/clipboard.min.js"></script><meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script><script src="../../site_libs/quarto-search/fuse.min.js"></script><script src="../../site_libs/quarto-search/quarto-search.js"></script><link href="../../themockup.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script><script src="../../site_libs/quarto-html/popper.min.js"></script><script src="../../site_libs/quarto-html/tippy.umd.min.js"></script><script src="../../site_libs/quarto-html/anchor.min.js"></script><link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link id="quarto-text-highlighting-styles" href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script><link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="The MockUp - Reading tables from images with magick">
<meta property="og:description" content="magick is an R package for manipulating images in R
">
<meta property="og:image" content="https://themockup.blog/posts/2021-01-18-reading-tables-from-images-with-magick/norm_normal_file_format.png">
<meta property="og:site-name" content="The MockUp">
<meta property="og:image:height" content="474">
<meta property="og:image:width" content="303">
<meta name="twitter:title" content="The MockUp - Reading tables from images with magick">
<meta name="twitter:description" content="magick is an R package for manipulating images in R
">
<meta name="twitter:image" content="https://themockup.blog/posts/2021-01-18-reading-tables-from-images-with-magick/norm_normal_file_format.png">
<meta name="twitter:creator" content="@thomas_mock">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="474">
<meta name="twitter:image-width" content="303">
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">The MockUp</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html">Blog</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../static/resources/resources.html">Resources</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jthomasmock"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/thomas_mock"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"><i class="bi bi-rss" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://jthomasmock.github.io/gtExtras/"><i class="bi bi-table" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://drinksbytom.com"><i class="bi bi-cup-straw" role="img">
</i> 
 </a>
  </li>  
</ul>
<div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Reading tables from images with magick</h1>
                          <div class="quarto-categories">
                <div class="quarto-category">magick</div>
                <div class="quarto-category">web scraping</div>
              </div>
                  </div>
  </div>
    
  <div>
    <div class="description">
      <p>magick is an R package for manipulating images in R</p>
    </div>
  </div>




  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Thomas Mock </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">01-18-2021</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#imagemagick" id="toc-imagemagick" class="nav-link active" data-scroll-target="#imagemagick">ImageMagick</a></li>
  <li><a href="#the-problem" id="toc-the-problem" class="nav-link" data-scroll-target="#the-problem">The problem</a></li>
  <li>
<a href="#excel-screenshot" id="toc-excel-screenshot" class="nav-link" data-scroll-target="#excel-screenshot">Excel Screenshot</a>
  <ul class="collapse">
<li><a href="#remove-the-background-and-grid" id="toc-remove-the-background-and-grid" class="nav-link" data-scroll-target="#remove-the-background-and-grid">Remove the background and grid</a></li>
  <li><a href="#crop-the-image" id="toc-crop-the-image" class="nav-link" data-scroll-target="#crop-the-image">Crop the image</a></li>
  <li><a href="#try-ocr" id="toc-try-ocr" class="nav-link" data-scroll-target="#try-ocr">Try OCR</a></li>
  <li><a href="#make-a-tibble" id="toc-make-a-tibble" class="nav-link" data-scroll-target="#make-a-tibble">Make a Tibble</a></li>
  <li><a href="#tidy-the-tibble" id="toc-tidy-the-tibble" class="nav-link" data-scroll-target="#tidy-the-tibble">Tidy the Tibble</a></li>
  <li><a href="#write-it-as-a-function" id="toc-write-it-as-a-function" class="nav-link" data-scroll-target="#write-it-as-a-function">Write it as a Function</a></li>
  </ul>
</li>
  <li>
<a href="#example-2" id="toc-example-2" class="nav-link" data-scroll-target="#example-2">Example 2</a>
  <ul class="collapse">
<li><a href="#get-the-raw-img" id="toc-get-the-raw-img" class="nav-link" data-scroll-target="#get-the-raw-img">Get the raw img</a></li>
  <li><a href="#clean-it-up" id="toc-clean-it-up" class="nav-link" data-scroll-target="#clean-it-up">Clean it up</a></li>
  <li><a href="#crop-the-image-1" id="toc-crop-the-image-1" class="nav-link" data-scroll-target="#crop-the-image-1">Crop the image</a></li>
  <li><a href="#try-ocr-1" id="toc-try-ocr-1" class="nav-link" data-scroll-target="#try-ocr-1">Try OCR</a></li>
  <li><a href="#create-a-function" id="toc-create-a-function" class="nav-link" data-scroll-target="#create-a-function">Create a function</a></li>
  <li><a href="#apply-the-function" id="toc-apply-the-function" class="nav-link" data-scroll-target="#apply-the-function">Apply the function</a></li>
  <li><a href="#clean-it-up-1" id="toc-clean-it-up-1" class="nav-link" data-scroll-target="#clean-it-up-1">Clean it up</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><section id="imagemagick" class="level1"><h1>ImageMagick</h1>
<p><a href="https://imagemagick.org/index.php">ImageMagick</a> is a robust and comprehensive open-source image processing library, and per the official <a href="https://imagemagick.org/index.php">docs</a>:</p>
<blockquote class="blockquote">
<p>Use ImageMagick® to create, edit, compose, or convert bitmap images. It can read and write images in a variety of formats (over 200) including PNG, JPEG, GIF, HEIC, TIFF, DPX, EXR, WebP, Postscript, PDF, and SVG. ImageMagick can resize, flip, mirror, rotate, distort, shear and transform images, adjust image colors, apply various special effects, or draw text, lines, polygons, ellipses and Bézier curves.</p>
</blockquote>
<p>While you can use it from various APIs, tools or CLIs, one of the easiest ways for R users to get started is with the R wrapper by ROpenSci’s Jeroen Ooms called <a href="https://docs.ropensci.org/magick/index.html"><code>magick</code></a>. This package provides a large set of pipe-friendly functions allowing for interactive editing and testing.</p>
<p>I’ve written briefly about <code>magick</code> before, specifically in using it to <a href="https://themockup.blog/posts/2019-01-09-add-a-logo-to-your-plot/">add logos to final <code>ggplot2</code> images</a>, but today will be a different use-case, namely using <code>magick</code> to read data embedded in images.</p>
<p>Another note is that while the docs for <code>ImageMagick</code> proper and the <code>magick</code> R wrapper are very good, <code>ImageMagick</code> is an entire piece of software. This means that there is an amazing breadth of applications, knowledge, and tricks to apply. I think of it a lot like <code>regex</code>, where it’s very useful but for many applications we only scratch the surface. For a nice “cookbook” for using <code>ImageMagick</code>, check out this <a href="https://legacy.imagemagick.org/Usage/">resource</a>. It’s a “legacy” guide, but many of the examples can be converted to <code>magick</code> in R or from the CLI itself.</p>
</section><section id="the-problem" class="level1 page-columns page-full"><h1>The problem</h1>
<p>There are many times where someone shares data as an image, whether intentionally due to software constraints (ie Twitter) or as a result of not understanding the implications (image inside a PDF or in a Word Doc). <a href="https://xkcd.com/2116/">xkcd.com</a> jokingly refers to this as <code>.norm</code> or as the Normal File Format. While it’s far from ideal or a <em>real</em> file format, it’s all too common to see data as images in the “wild”. I’ll be using some examples from Twitter images and extracting the raw data from these. There are multiple levels of difficulty, namely that screenshots on Twitter are not uniform, often of relatively low quality (ie DPI), and contain additional “decoration” like colors or grid-lines. We’ll do our best to make it work!</p>
<div class="aside page-columns page-full">
<div class="cell page-columns page-full">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="norm_normal_file_format.png" class="img-fluid figure-img" width="152"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption margin-caption">https://xkcd.com/2116/</figcaption><p></p>
</figure>
</div>
</div>
</div>
</div>
<p>Example one is from Seth Walder, who was kind enough to share the raw data for ESPN’s “Sacks created” stat. Given that it was a quality image, and there were 3 of them, I wanted to try OCR (optical character recognition)!</p>
<blockquote class="twitter-tweet blockquote">
<p lang="en" dir="ltr">
OK here's the top 46 players – everyone with at least 5.5 sacks created.<br><br>Sacks created is an ESPN stat using NFL Next Gen Stats data. <a href="https://t.co/cNL23Dna9h">pic.twitter.com/cNL23Dna9h</a>
</p>
— Seth Walder (<span class="citation" data-cites="SethWalder">@SethWalder</span>) <a href="https://twitter.com/SethWalder/status/1349785021922631682?ref_src=twsrc%5Etfw">January 14, 2021</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></section><section id="excel-screenshot" class="level1 page-columns page-full"><h1>Excel Screenshot</h1>
<p>So let’s get after it! We’ll need two packages, but I’ll also load <code>tidyverse</code> for the eventual analysis/plotting as well. Also, note that I adapted some of this from a <a href="code%20adapted%20from:%20https://stackoverflow.com/questions/54000691/extracting-tables-from-jpeg-into-a-dataframe-in-r">StackOverflow post</a> talking about extracting tables from images.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/magick/">magick</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/tesseract/">tesseract</a></span><span class="op">)</span>

<span class="va">sack_url</span> <span class="op">&lt;-</span> <span class="st">"https://pbs.twimg.com/media/ErtmQ1PXYAEUQoY?format=jpg&amp;name=900x900"</span>
<span class="va">raw_img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/editing.html">image_read</a></span><span class="op">(</span><span class="va">sack_url</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, while interactively you can just “print” the <code>magick</code> object and it will show up in the viewer pane, for this blog-post I’ll need to explicitly “show” it. I’ll call <code>magick::image_ggplot(&lt;img object&gt;)</code> to print it throughout the post.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://docs.ropensci.org/magick/reference/image_ggplot.html">image_ggplot</a></span><span class="op">(</span><span class="va">raw_img</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This looks like a relatively clean image, the only major problems being that it’s relatively low-DPI, it has some symbols (team logos), and it has alternating colors along with gridlines (which can mess with the OCR). We can try a “naive” OCR as seen below.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">raw_img</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_crop</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">110</span>, <span class="fl">45</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/ocr.html">ocr</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Aaron Donald (DE - LA) 19.0,\nMyles Garrett (DE - CLE) 16.5\nTJ. Watt (OLB - PIT) 14.5\nKhalil Mack (OLB - CHI) 13.0\nJustin Houston (DE - IND) 12.0\nEmmanuel Ogbah (DE - MIA) 11.0\nCarl Lawson (DE - CIN) 10.5\nBrandon Graham (DE - PHI) 10.0\nDeMarcus Lawrence (DE - DAL) 10.0\nYannick Ngakoue (DE - BAL) 10.0,\nMontez Sweat (DE - WAS) 10.0\nCarlos’ Dunlap (DE - SEA) 9.0\nCameron Jordan (DE - NO) 9.0\nKerry Hyder (DE - SF) 9.0\nErna poner (ole -TB) 9.0\nStephon Tuitt (DE - PIT) 9.0\n"</code></pre>
</div>
</div>
<p>Ultimately, it does pretty well! But you can see that there are some “misses” if we look closely. Let’s make it easier on the OCR engine by cleaning up the image for higher contrast.</p>
<section id="remove-the-background-and-grid" class="level2"><h2 class="anchored" data-anchor-id="remove-the-background-and-grid">Remove the background and grid</h2>
<p>We’ll first start by converting the color image to greyscale via <code><a href="https://docs.ropensci.org/magick/reference/color.html">image_quantize()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">raw_img</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html">image_quantize</a></span><span class="op">(</span>colorspace <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/image_ggplot.html">image_ggplot</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can remove the grid by converting “white” colors to transparent, and allowing for some “fuzzy” approximation of colors that are close to white or “touching”. There’s a lot more to <code>fuzz</code> in that it’s the “relative color distance (value between 0 and 100) to be considered similar in the filling algorithm”, but I’m not a color space expert by any means.</p>
<p>Below we have an example of <code>fuzz = 0</code>, <code>fuzz = 20</code>, <code>fuzz = 40</code>, <code>fuzz = 60</code>. Each increase does remove a bit of “noise”, but is also reducing the quality of the “signal”.</p>
<details><summary>
Code for Combo
</summary><div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">fuzz_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fuzz</span><span class="op">)</span><span class="op">{</span>
  <span class="va">raw_img</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html">image_quantize</a></span><span class="op">(</span>colorspace <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html">image_transparent</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, fuzz<span class="op">=</span><span class="va">fuzz</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html">image_background</a></span><span class="op">(</span><span class="st">"white"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_crop</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">150</span>,<span class="fl">110</span>, <span class="fl">45</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">fuzz_fun</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="300"></p>
</div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">combo_fuzz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="fu">fuzz_fun</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,
  <span class="fu">fuzz_fun</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span>,
  <span class="fu">fuzz_fun</span><span class="op">(</span><span class="fl">40</span><span class="op">)</span>,
  <span class="fu">fuzz_fun</span><span class="op">(</span><span class="fl">60</span><span class="op">)</span>
<span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/animation.html">image_append</a></span><span class="op">(</span>stack <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details><div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://docs.ropensci.org/magick/reference/image_ggplot.html">image_ggplot</a></span><span class="op">(</span><span class="va">combo_fuzz</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In practical terms, we are balancing increase <code>fuzz</code> to remove unnecessary components (eg grid lines) while leaving the actual characters there. Increasing fuzz will remove more “noise” but will eventually start to eat away at the actual “signal” as well.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">no_grid</span> <span class="op">&lt;-</span> <span class="va">raw_img</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html">image_quantize</a></span><span class="op">(</span>colorspace <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
   <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html">image_transparent</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, fuzz<span class="op">=</span><span class="fl">20</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
   <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html">image_background</a></span><span class="op">(</span><span class="st">"white"</span><span class="op">)</span> 

<span class="fu"><a href="https://docs.ropensci.org/magick/reference/image_ggplot.html">image_ggplot</a></span><span class="op">(</span><span class="va">no_grid</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>So we’ve taken white and converted it to transparent, and then set the image background back to “white”.</p>
<p>You can also remove continuous lines with a “thinning” method. We can use <code><a href="https://docs.ropensci.org/magick/reference/morphology.html">image_morphology()</a></code> coupled with a rectangular kernel to remove straight horizontal lines for the most part. You can read <code>Rectangle:20x1</code> as finding rectangles about 20 pixels wide x 1 pixel high. We couple this with <code><a href="https://docs.ropensci.org/magick/reference/effects.html">image_negate()</a></code> as otherwise it will focus on the characters.</p>
<p>So we’ll <code>negate</code> &gt; <code>thin</code> &gt; <code>negate</code> to get back to our white background sans grid-lines. While this works pretty well, it’s not <em>always</em> necessary for the OCR. I did want to show it as it can be helpful in some situations.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">no_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/effects.html">image_negate</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/image_ggplot.html">image_ggplot</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">no_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/effects.html">image_negate</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># negate</span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/morphology.html">image_morphology</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"Thinning"</span>, kernel <span class="op">=</span> <span class="st">"Rectangle:20x1"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/effects.html">image_negate</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># back to white</span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/image_ggplot.html">image_ggplot</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This worked pretty well! However, remember that we don’t always have to do this. We’ll also still need to crop the image to remove the team logos as they can’t be parsed as text.</p>
</section><section id="crop-the-image" class="level2"><h2 class="anchored" data-anchor-id="crop-the-image">Crop the image</h2>
<p><code><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area()</a></code> is used in various functions to indicate the starting width/heights and then the offset, all in pixels.</p>
<blockquote class="blockquote">
<p><code>geometry_area(width = NULL, height = NULL, x_off = 0, y_off = 0)</code></p>
</blockquote>
<p>Note that you’re always “starting” from the top and left sides, and we’re passing the <code><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area()</a></code> to <code>image_crop</code> to crop the image itself.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co"># remove the top 20 pixels</span>
<span class="va">no_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_crop</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>,<span class="fl">110</span>, <span class="fl">45</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/image_ggplot.html">image_ggplot</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>So this techniques can be used to cut out specific portions of an image, which is another useful technique for tricky columns. For now, let’s hope we can use ALL the data together.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">no_grid_crop</span> <span class="op">&lt;-</span> <span class="va">no_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_crop</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>,<span class="fl">110</span>, <span class="fl">45</span><span class="op">)</span><span class="op">)</span>

<span class="va">no_grid_crop</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/image_ggplot.html">image_ggplot</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="try-ocr" class="level2"><h2 class="anchored" data-anchor-id="try-ocr">Try OCR</h2>
<p>We can try our first OCR now! Note that <code><a href="https://docs.ropensci.org/magick/reference/ocr.html">image_ocr()</a></code> is just calling <code>tesseract</code> behind the scenes.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">no_grid_crop</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/ocr.html">image_ocr</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Aaron Donald (DE - LA) 19.0\nMyles Garrett (DE - CLE) 16.5\nT.J. Watt (OLB - PIT) 14.5\nKhalil Mack (OLB - CHI) 13.0\nJustin Houston (DE - IND) 12.0\nEmmanuel Ogbah (DE - MIA) 11.0\nCarl Lawson (DE - CIN) 10.5\nBrandon Graham (DE - PHI) 10.0\nDeMarcus Lawrence (DE - DAL) 10.0\nYannick Ngakoue (DE - BAL) 10.0\nMontez Sweat (DE - WAS) 10.0\nCarlos Dunlap (DE - SEA) 9.0\nCameron Jordan (DE - NO) 9.0\nKerry Hyder (DE - SF) 9.0\nShaquil Barrett (OLB - TB) 9.0\nStephon Tuitt (DE - PIT) 9.0\nRomeo Okwara (DE - DET) 9.0\n"</code></pre>
</div>
</div>
<p>This did a great job, but what about this raw text string we ended up with? Also note that <code><a href="https://docs.ropensci.org/magick/reference/ocr.html">image_ocr()</a></code> is just a wrapper around <code><a href="https://docs.ropensci.org/tesseract/reference/ocr.html">tesseract::ocr()</a></code>.</p>
<p>Let’s go into <code>tesseract</code> proper to try some robust things out!</p>
<p>I’m going to focus on one numeric “column” first to keep things relatively simpler. We’ll use <code>image_crop</code> to grab the column of interest, then we’ll call <code><a href="https://docs.ropensci.org/tesseract/reference/ocr.html">tesseract::ocr()</a></code> on it. We can provide some options to the engine, namely that we’re expecting only spaces, numbers, or a decimal. This will explicitly prevent 5 being converted to S for example. It does really well here!</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">num_only</span> <span class="op">&lt;-</span> <span class="fu">tesseract</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/tesseract/reference/tesseract.html">tesseract</a></span><span class="op">(</span>
  options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>tessedit_char_whitelist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">".0123456789 "</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">no_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html">image_quantize</a></span><span class="op">(</span>colorspace <span class="op">=</span> <span class="st">'gray'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/thresholding.html">image_threshold</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_crop</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">0</span>, <span class="fl">600</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/ocr.html">ocr</a></span><span class="op">(</span>engine <span class="op">=</span> <span class="va">num_only</span><span class="op">)</span> </code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "19.0\n16.5\n14.5\n13.0\n12.0\n11.0\n10.5\n10.0\n10.0\n10.0\n10.0\n9.0\n9.0\n9.0\n9.0\n9.0\n9.0\n"</code></pre>
</div>
</div>
<p>But we have text, numbers, and some symbols like <code>(</code>.</p>
<p>So let’s pass those as limitations to the engine, and then we can take the raw text and turn it into a dataframe/tibble.</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">combo</span> <span class="op">&lt;-</span> <span class="fu">tesseract</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/tesseract/reference/tesseract.html">tesseract</a></span><span class="op">(</span>
    options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      tessedit_char_whitelist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">letters</span>, <span class="va">LETTERS</span>, <span class="st">" "</span>, <span class="st">".0123456789 (-)"</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
      <span class="op">)</span>
  <span class="op">)</span>

<span class="va">raw_text</span> <span class="op">&lt;-</span> <span class="va">no_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html">image_quantize</a></span><span class="op">(</span>colorspace <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html">image_transparent</a></span><span class="op">(</span><span class="st">"white"</span>, fuzz <span class="op">=</span> <span class="fl">22</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html">image_background</a></span><span class="op">(</span><span class="st">"white"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/thresholding.html">image_threshold</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_crop</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">110</span>, <span class="fl">45</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/ocr.html">ocr</a></span><span class="op">(</span>engine <span class="op">=</span> <span class="va">combo</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="make-a-tibble" class="level2"><h2 class="anchored" data-anchor-id="make-a-tibble">Make a Tibble</h2>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">raw_text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Aaron Donald (DE - LA) 19.0\nMyles Garrett (DE - CLE) 16.5\nT.J. Watt (OLB - PIT) 14.5\nKhalil Mack (OLB - CHI) 13.0\nJustin Houston (DE - IND) 12.0\nEmmanuel Ogbah (DE - MIA) 11.0\nCarl Lawson (DE - CIN) 10.5\nBrandon Graham (DE - PHI) 10.0\nDeMarcus Lawrence (DE - DAL) 10.0\nYannick Ngakoue (DE - BAL) 10.0\nMontez Sweat (DE - WAS) 10.0\nCarlos Dunlap (DE - SEA) 9.0\nCameron Jordan (DE - NO) 9.0\nKerry Hyder (DE - SF) 9.0\nShaquil Barrett (OLB - TB) 9.0\nStephon Tuitt (DE - PIT) 9.0\nRomeo Okwara (DE - DET) 9.0\n"</code></pre>
</div>
</div>
<p>This looks pretty much perfect! We just now need to get it into a dataframe. We can accomplish this by splitting on each new row (<code>\n</code>) and then adding that as a column in a tibble.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">raw_tibble</span> <span class="op">&lt;-</span> <span class="va">raw_text</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">.</span><span class="op">)</span> 

<span class="va">raw_tibble</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 18 × 1
   data                               
   &lt;chr&gt;                              
 1 "Aaron Donald (DE - LA) 19.0"      
 2 "Myles Garrett (DE - CLE) 16.5"    
 3 "T.J. Watt (OLB - PIT) 14.5"       
 4 "Khalil Mack (OLB - CHI) 13.0"     
 5 "Justin Houston (DE - IND) 12.0"   
 6 "Emmanuel Ogbah (DE - MIA) 11.0"   
 7 "Carl Lawson (DE - CIN) 10.5"      
 8 "Brandon Graham (DE - PHI) 10.0"   
 9 "DeMarcus Lawrence (DE - DAL) 10.0"
10 "Yannick Ngakoue (DE - BAL) 10.0"  
11 "Montez Sweat (DE - WAS) 10.0"     
12 "Carlos Dunlap (DE - SEA) 9.0"     
13 "Cameron Jordan (DE - NO) 9.0"     
14 "Kerry Hyder (DE - SF) 9.0"        
15 "Shaquil Barrett (OLB - TB) 9.0"   
16 "Stephon Tuitt (DE - PIT) 9.0"     
17 "Romeo Okwara (DE - DET) 9.0"      
18 ""                                 </code></pre>
</div>
</div>
<p>Now we have essentially perfect data at this point, we just need to separate out our columns and drop the row without any data.</p>
</section><section id="tidy-the-tibble" class="level2"><h2 class="anchored" data-anchor-id="tidy-the-tibble">Tidy the Tibble</h2>
<p>We’ll first drop any rows where the character string is &lt; 2. We can then use <code><a href="https://tidyr.tidyverse.org/reference/separate.html">tidyr::separate()</a></code> to separate one column into 4 new columns as player, position, team, and sacks. There are multiple separators, which for the example seen <code>T.J. Watt (OLB - PIT) 14.5</code> are:</p>
<ul>
<li>
<code>T.J.Watt</code> then <code>(</code> represented as “<code>\\(</code>”<br>
</li>
<li>
<code>OLB</code> then <code>-</code> represented as “<code>-</code>”<br>
</li>
<li>
<code>PIT</code> then <code>)</code> represented as “<code>\\)</code>”<br>
</li>
<li>which leaves us with <code>14.5</code> at the end</li>
</ul>
<p>We have to “escape” the parentheses with <code>\\</code> so that regex can understand them. The <code>|</code> inside the sep arguments tell the regex to separate at a match of a white-space + parentheses OR white-space + dash OR parentheses + white-space.</p>
<p>As our last step, we’ll convert sacks to a double column, and then <strong>BOOM</strong>!</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">raw_tibble</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html">str_length</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">2</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span>
    <span class="va">data</span>, 
    into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"player"</span>, <span class="st">"position"</span>, <span class="st">"team"</span>, <span class="st">"sacks"</span><span class="op">)</span>, 
    sep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">" \\(| - |\\) "</span><span class="op">)</span>
    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span><span class="op">(</span><span class="va">sacks</span><span class="op">)</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 17 × 4
   player            position team  sacks
   &lt;chr&gt;             &lt;chr&gt;    &lt;chr&gt; &lt;dbl&gt;
 1 Aaron Donald      DE       LA     19  
 2 Myles Garrett     DE       CLE    16.5
 3 T.J. Watt         OLB      PIT    14.5
 4 Khalil Mack       OLB      CHI    13  
 5 Justin Houston    DE       IND    12  
 6 Emmanuel Ogbah    DE       MIA    11  
 7 Carl Lawson       DE       CIN    10.5
 8 Brandon Graham    DE       PHI    10  
 9 DeMarcus Lawrence DE       DAL    10  
10 Yannick Ngakoue   DE       BAL    10  
11 Montez Sweat      DE       WAS    10  
12 Carlos Dunlap     DE       SEA     9  
13 Cameron Jordan    DE       NO      9  
14 Kerry Hyder       DE       SF      9  
15 Shaquil Barrett   OLB      TB      9  
16 Stephon Tuitt     DE       PIT     9  
17 Romeo Okwara      DE       DET     9  </code></pre>
</div>
</div>
</section><section id="write-it-as-a-function" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="write-it-as-a-function">Write it as a Function</h2>
<p>We can wrap this process into a reusable function, and then call it on our 3 images of interest!</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">scrape_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">url_in</span>, <span class="va">crop_left</span>, <span class="va">crop_top</span><span class="op">)</span><span class="op">{</span>
  <span class="va">raw_img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/editing.html">image_read</a></span><span class="op">(</span><span class="va">url_in</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html">image_quantize</a></span><span class="op">(</span>colorspace <span class="op">=</span> <span class="st">'gray'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html">image_transparent</a></span><span class="op">(</span><span class="st">"white"</span>, fuzz<span class="op">=</span><span class="fl">22</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html">image_background</a></span><span class="op">(</span><span class="st">"white"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/thresholding.html">image_threshold</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_crop</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="va">crop_left</span>, <span class="va">crop_top</span><span class="op">)</span><span class="op">)</span> 
  
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/ocr.html">image_ocr</a></span><span class="op">(</span><span class="va">raw_img</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html">str_length</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span>
      <span class="va">data</span>, 
      into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"player"</span>, <span class="st">"position"</span>, <span class="st">"team"</span>, <span class="st">"sacks"</span><span class="op">)</span>, 
      sep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">" \\(| - |\\) "</span><span class="op">)</span>
      <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span><span class="op">(</span><span class="va">sacks</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sacks <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">sacks</span> <span class="op">&gt;=</span> <span class="fl">20</span>, <span class="va">sacks</span><span class="op">/</span><span class="fl">10</span>, <span class="va">sacks</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then call our new function! You may notice that I added a <code>mutate</code> above which protects against missing decimal places. Trey Hendrickson’s decimal place is apparently hard for the parser to “capture”.</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co"># output to tibble</span>
<span class="va">cr_sacks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  url_in <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"https://pbs.twimg.com/media/ErtmQ1PXYAEUQoY?format=jpg&amp;name=900x900"</span>,
    <span class="st">"https://pbs.twimg.com/media/ErtmSLlXMAAvylA?format=jpg&amp;name=900x900"</span>,
    <span class="st">"https://pbs.twimg.com/media/ErtmTUGW8AEZ6Cy?format=jpg&amp;name=900x900"</span>
    <span class="op">)</span>,
  crop_left <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">110</span>, <span class="fl">95</span>, <span class="fl">95</span><span class="op">)</span>,
  crop_top <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">45</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>
<span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">pmap_df</a></span><span class="op">(</span><span class="va">scrape_fun</span><span class="op">)</span>

<span class="va">cr_sacks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 46 × 4
   player            position team  sacks
   &lt;chr&gt;             &lt;chr&gt;    &lt;chr&gt; &lt;dbl&gt;
 1 Aaron Donald      DE       LA     19  
 2 Myles Garrett     DE       CLE    16.5
 3 T.J. Watt         OLB      PIT    14.5
 4 Khalil Mack       OLB      CHI    13  
 5 Justin Houston    DE       IND    12  
 6 Emmanuel Ogbah    DE       MIA    11  
 7 Carl Lawson       DE       CIN    10.5
 8 Brandon Graham    DE       PHI    10  
 9 DeMarcus Lawrence DE       DAL    10  
10 Yannick Ngakoue   DE       BAL    10  
# … with 36 more rows</code></pre>
</div>
</div>
<p>We can plot it just to be safe, and to see if everything “checks out”! We get a range we expected, and see that T.J. Watt and Aaron Donald create many more of their own sacks relative to their positions.</p>
<div class="cell page-columns page-full">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">cr_sacks</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">position</span> <span class="op">==</span> <span class="st">"LB"</span>, <span class="st">"OLB"</span>, <span class="va">position</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sacks</span>, y <span class="op">=</span> <span class="va">position</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggridges</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/ggridges/reference/geom_density_ridges.html">geom_density_ridges</a></span><span class="op">(</span>quantile_lines <span class="op">=</span> <span class="cn">TRUE</span>, quantiles <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cr_sacks</span>, <span class="va">player</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Aaron Donald"</span>, <span class="st">"T.J. Watt"</span><span class="op">)</span><span class="op">)</span>,
    size <span class="op">=</span> <span class="fl">3</span>
    <span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggridges</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/ggridges/reference/theme_ridges.html">theme_ridges</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>
    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,
    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,
    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>,
    plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,
    panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
    axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="st">"\nCreated Sacks"</span>, y <span class="op">=</span> <span class="st">""</span>,
    title <span class="op">=</span> <span class="st">"T.J. Watt and A. Donald are both outliers amongst their positions"</span>,
    subtitle <span class="op">=</span> <span class="st">"Created Sacks by position"</span>,
    caption <span class="op">=</span> <span class="st">"Data: ESPN | Plot: @thomas_mock"</span>
    <span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Picking joint bandwidth of 1.05</code></pre>
</div>
<div class="cell-output-display column-column-page-inset">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="1500"></p>
</div>
</div>
</section></section><section id="example-2" class="level1"><h1>Example 2</h1>
<p>Example two is from Brian Burke, who was kind enough to share the raw data for NFL playoff leverage for week 17 as a screenshot. At the time, I manually copied these over to a dataframe, but Ben Baldwin asked if there was a “better” way. Image OCR (optical character recognition) is a potentially more reproducible way!</p>
<blockquote class="twitter-tweet blockquote">
<p lang="en" dir="ltr">
Sorry, no pretty charts for now. But here are the raw numbers. <a href="https://t.co/wZ3j9bXzTN">pic.twitter.com/wZ3j9bXzTN</a>
</p>
— Brian Burke (<span class="citation" data-cites="bburkeESPN">@bburkeESPN</span>) <a href="https://twitter.com/bburkeESPN/status/1339616433408528384?ref_src=twsrc%5Etfw">December 17, 2020</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>Note that our process is almost identical to the previous example, but there are some considerations as the image is a bit more difficult to work with.</p>
<p>Now, this image is more problematic for two main reasons.</p>
<ol type="1">
<li>The image itself is <em>much</em> smaller, specifically about 60% smaller than our previous example and of low quality<br>
</li>
<li>The fonts in use are worse (not monospaced and have serifs), and not bold</li>
</ol>
<p>This is going to be <strong>harder</strong> than before.</p>
<section id="get-the-raw-img" class="level2"><h2 class="anchored" data-anchor-id="get-the-raw-img">Get the raw img</h2>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">burke</span> <span class="op">&lt;-</span> <span class="st">"https://pbs.twimg.com/media/EpdF4fzW4AEeOvF?format=png&amp;name=small"</span>
<span class="va">raw_img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/editing.html">image_read</a></span><span class="op">(</span><span class="va">burke</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, again while interactively you can just “print” the <code>magick</code> object and it will show up in the RStudio viewer pane, for this blog-post I’ll need to explicitly “show” it. I’ll call <code>magick::image_ggplot(&lt;img object&gt;)</code> to print it throughout the post.</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://docs.ropensci.org/magick/reference/image_ggplot.html">image_ggplot</a></span><span class="op">(</span><span class="va">raw_img</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This looks like a relatively clean image, the only major problems as mentioned above are that it’s very low-quality along with not ideal fonts, and it cuts off some of the data for team.</p>
</section><section id="clean-it-up" class="level2"><h2 class="anchored" data-anchor-id="clean-it-up">Clean it up</h2>
<p>We can remove the grid by converting “white” colors to transparent, and allowing for some “fuzzy” approximation of colors that are close to white or “touching”. There’s a lot more to <code>fuzz</code> in that it’s the “relative color distance (value between 0 and 100) to be considered similar in the filling algorithm”, but I’m not a color space expert by any means.</p>
<p>In practical terms, we are balancing increase <code>fuzz</code> to remove unnecessary components (eg grid lines) while leaving the actual characters there. Increasing fuzz will remove more “noise” but will eventually start to eat away at the actual “signal” as well.</p>
<p>Below we have an example of <code>fuzz = 0</code>, <code>fuzz = 20</code>, <code>fuzz = 50</code>, <code>fuzz = 70</code>.</p>
<p>So we’ve taken white and converted it to transparent, and then set the image background back to “white”.</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">no_grid</span> <span class="op">&lt;-</span> <span class="va">raw_img</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
   <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html">image_transparent</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, fuzz<span class="op">=</span><span class="fl">20</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
   <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html">image_background</a></span><span class="op">(</span><span class="st">"white"</span><span class="op">)</span> 

<span class="fu"><a href="https://docs.ropensci.org/magick/reference/image_ggplot.html">image_ggplot</a></span><span class="op">(</span><span class="va">no_grid</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>You can also remove continuous lines with a “thinning” method. We can use <code><a href="https://docs.ropensci.org/magick/reference/morphology.html">image_morphology()</a></code> coupled with a rectangular kernel to remove straight horizontal lines for the most part. You can read <code>Rectangle:20x1</code> as finding rectangles about 20 pixels wide x 1 pixel high. We couple this with <code><a href="https://docs.ropensci.org/magick/reference/effects.html">image_negate()</a></code> as otherwise it will focus on the characters.</p>
<p>So we’ll <code>negate</code> &gt; <code>thin</code> &gt; <code>negate</code> to get back to our white background sans grid-lines.</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">no_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/effects.html">image_negate</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/image_ggplot.html">image_ggplot</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can apply the thinning morph as seen below, flipping back and forth with <code><a href="https://docs.ropensci.org/magick/reference/effects.html">image_negate()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">no_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/effects.html">image_negate</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/morphology.html">image_morphology</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"Thinning"</span>, kernel <span class="op">=</span> <span class="st">"Rectangle:20x1"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/effects.html">image_negate</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/image_ggplot.html">image_ggplot</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This worked pretty well! However, because of the mis-alignment of the column labels and the columns themselves, I’m just going to trim the top off.</p>
</section><section id="crop-the-image-1" class="level2"><h2 class="anchored" data-anchor-id="crop-the-image-1">Crop the image</h2>
<p><code><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area()</a></code> is used in various functions to indicate the starting width/heights and then the offset, all in pixels.</p>
<blockquote class="blockquote">
<p><code>geometry_area(width = NULL, height = NULL, x_off = 0, y_off = 0)</code></p>
</blockquote>
<p>Note that you’re always “starting” from the top and left sides, and we’re passing the <code><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area()</a></code> to <code>image_crop</code> to crop the image itself.</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co"># remove the top 20 pixels</span>
<span class="va">no_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_crop</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/image_ggplot.html">image_ggplot</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>So this techniques can be used to cut out specific portions of an image, which is another useful technique for tricky columns. For now, let’s hope we can use ALL the data together.</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">no_grid_crop</span> <span class="op">&lt;-</span> <span class="va">no_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_crop</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span>

<span class="va">no_grid_crop</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/image_ggplot.html">image_ggplot</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="try-ocr-1" class="level2"><h2 class="anchored" data-anchor-id="try-ocr-1">Try OCR</h2>
<p>We can try our first OCR now! Note that <code><a href="https://docs.ropensci.org/magick/reference/ocr.html">image_ocr()</a></code> is just calling <code>tesseract</code> behind the scenes.</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">no_grid_crop</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/ocr.html">image_ocr</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Bills 100 99.3 07\nPackers 100 100 0\nRams 100989 11\nChiefs 100 100 0\nsaints 100 100 0\nSeahawks 100 (97.7 23\nSteelers 100 100 0\nBuccaneer 99.5 92.6 69\nTitans 97.6 787 18.9\nColts 94.9 6640285\nBrowns 946 0 «675 TA\nRavens 90.1 S18 383\nFootballT 88.6 583 303\nCardinals 65.7. 25.7 40\nDolphins 48.7 14 353\nGiants 413 10-313\nBears 35.3 18 (335\nVikings 317 430 278\nRaiders 29.1 45 246\nEagles 18.3 3400 149\n49ers 14.5 os 14\nPatriots 58 0 58\nCowboys 23 0 23\nLions 19 0 19\nPanthers O41 oO O41\n"</code></pre>
</div>
</div>
<p>This did a decent job, but I can already see some “problems”.</p>
<p>The Rams row is “squished” together, the Browns have some letters instead of numbers, and the Ravens have a “S” instead of a 5.</p>
<p>Let’s go into <code>tesseract</code> proper to try some robust things out!</p>
<p>I’m going to focus on one “column” first to keep things relatively simpler. We’ll use <code>image_crop</code> to grab the column of interest, then we’ll call <code><a href="https://docs.ropensci.org/tesseract/reference/ocr.html">tesseract::ocr()</a></code> on it. We can provide some options to the engine, namely that we’re expecting only spaces, numbers, or a decimal. This will explicitly prevent 5 being converted to S for example.</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">num_only</span> <span class="op">&lt;-</span> <span class="fu">tesseract</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/tesseract/reference/tesseract.html">tesseract</a></span><span class="op">(</span>
  options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>tessedit_char_whitelist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">".0123456789 "</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>
<span class="va">no_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html">image_quantize</a></span><span class="op">(</span>colorspace <span class="op">=</span> <span class="st">'gray'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/thresholding.html">image_threshold</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_crop</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area</a></span><span class="op">(</span><span class="fl">80</span>, <span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/ocr.html">ocr</a></span><span class="op">(</span>engine <span class="op">=</span> <span class="va">num_only</span><span class="op">)</span> </code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "100\n100\n100\n100\n100\n100\n100\n99.5\n97.6\n94.9\n94.6\n90.1\n28.6\n657\n48.7\n41.3\n35.3\n317\n29.1\n18.3\n14.5\n5.8\n2.3\n1.9\n01\n"</code></pre>
</div>
</div>
<p>I’m going to “plot” the data to show some areas where mistakes were <em>still</em> made. We know that 100 is the max, and that the values are ranked, and thus should be always decreasing. We have at least 5 examples where the data is missing a period which causes it to be scaled improperly (10x larger than reality).</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">ocr_col1</span> <span class="op">&lt;-</span> <span class="va">no_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_crop</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area</a></span><span class="op">(</span><span class="fl">80</span>, <span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/ocr.html">ocr</a></span><span class="op">(</span>engine <span class="op">=</span> <span class="va">num_only</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/enframe.html">enframe</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span>

<span class="va">ocr_col1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
    <span class="va">value</span> <span class="op">&gt;</span> <span class="fl">100</span> <span class="op">~</span> <span class="st">"red"</span>,
    <span class="va">value</span> <span class="op">&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">~</span> <span class="st">"red"</span>,
    <span class="va">value</span> <span class="op">&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">value</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">~</span> <span class="st">"red"</span>,
    <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"black"</span>
  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">name</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">color</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_identity.html">scale_color_identity</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Again, due to the VERY low image quality (the original image is 72 DPI and only ~500 pixels high) we’re basically stuck with some of these manual steps. Regardless, we’ve got “better” data now that we’ve added our conversion logic. Those same 5 points now fall “accurately” into the appropriate range.</p>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">ocr_col1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
    <span class="va">value</span> <span class="op">&gt;</span> <span class="fl">100</span> <span class="op">~</span> <span class="st">"red"</span>,
    <span class="va">value</span> <span class="op">&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">~</span> <span class="st">"red"</span>,
    <span class="va">value</span> <span class="op">&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">value</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">~</span> <span class="st">"red"</span>,
    <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"black"</span>
  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    value <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">value</span> <span class="op">&gt;</span> <span class="fl">100</span>, <span class="va">value</span><span class="op">/</span><span class="fl">10</span>, <span class="va">value</span><span class="op">)</span>,
    value <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">name</span> <span class="op">&gt;=</span> <span class="fl">22</span>, <span class="va">value</span><span class="op">/</span><span class="fl">10</span>, <span class="va">value</span><span class="op">)</span>
    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">name</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">color</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_identity.html">scale_color_identity</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>So we’ve apparently “fixed” this column!</p>
</section><section id="create-a-function" class="level2"><h2 class="anchored" data-anchor-id="create-a-function">Create a function</h2>
<p>We’ll create a function so that we can split out each column, apply optimal characters or numeric to each and then recombine.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">img_ocr_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trim_width</span>, <span class="va">trim_start</span>, <span class="va">char_num</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">num_only</span> <span class="op">&lt;-</span> <span class="fu">tesseract</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/tesseract/reference/tesseract.html">tesseract</a></span><span class="op">(</span>
    options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>tessedit_char_whitelist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">".0123456789 "</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>

  <span class="va">combo</span> <span class="op">&lt;-</span> <span class="fu">tesseract</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/tesseract/reference/tesseract.html">tesseract</a></span><span class="op">(</span>
    options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      tessedit_char_whitelist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">letters</span>, <span class="va">LETTERS</span>, <span class="st">" "</span>, <span class="st">".0123456789 "</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
      <span class="op">)</span>
  <span class="op">)</span>


  <span class="va">input_char</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html">isTRUE</a></span><span class="op">(</span><span class="va">char_num</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">num_only</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">combo</span>
  <span class="op">}</span>

  <span class="va">no_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_crop</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area</a></span><span class="op">(</span><span class="va">trim_width</span>, <span class="fl">0</span>, <span class="va">trim_start</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/ocr.html">ocr</a></span><span class="op">(</span>engine <span class="op">=</span> <span class="va">input_char</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/enframe.html">enframe</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">name</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html">str_length</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>
<span class="op">}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can “find” the columns by cropping specific areas. Note that I’ve “recombined” all of them with <code><a href="https://docs.ropensci.org/magick/reference/animation.html">image_append()</a></code> so that you can see that each section together completes the table.</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="va">no_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_crop</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area</a></span><span class="op">(</span><span class="fl">80</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span>,
  <span class="va">no_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_crop</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span>,
  <span class="va">no_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_crop</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">0</span>, <span class="fl">140</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span>,
  <span class="va">no_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_crop</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_area</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">0</span>, <span class="fl">210</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/animation.html">image_append</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/image_ggplot.html">image_ggplot</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="reading-tables-from-images-with-magick_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="apply-the-function" class="level2"><h2 class="anchored" data-anchor-id="apply-the-function">Apply the function</h2>
<p>We can use <code><a href="https://purrr.tidyverse.org/reference/map2.html">purrr::pmap()</a></code> to apply the functions with each of our parameters, and then use <code>bind_cols</code> to create our actual dataset.</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">all_ocr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>trim_width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">80</span>, <span class="fl">50</span>, <span class="fl">50</span>, <span class="fl">50</span><span class="op">)</span>,
     trim_start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">140</span>, <span class="fl">210</span><span class="op">)</span>,
     char_num <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">pmap</a></span><span class="op">(</span><span class="va">img_ocr_fun</span><span class="op">)</span> 

<span class="va">data_df</span> <span class="op">&lt;-</span> <span class="va">all_ocr</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://purrr.tidyverse.org/reference/set_names.html">set_names</a></span><span class="op">(</span>nm <span class="op">=</span> <span class="st">"team"</span>, <span class="st">"win"</span>, <span class="st">"lose"</span>, <span class="st">"leverage"</span><span class="op">)</span> </code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
• `value` -&gt; `value...1`
• `value` -&gt; `value...2`
• `value` -&gt; `value...3`
• `value` -&gt; `value...4`</code></pre>
</div>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">data_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 25 × 4
   team      win   lose  leverage
   &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   
 1 Bills     100   99.3  07      
 2 Packers   100   100   0       
 3 Rams      100   98.9  11      
 4 Chiefs    100   100   0       
 5 Saints    100   100   0       
 6 Seahawks  100   977   23      
 7 Steelers  100   100   0       
 8 Buccaneer 99.5  92.6  69      
 9 Titans    97.6  18.7  18.9    
10 Colts     94.9  66.4  285     
# … with 15 more rows</code></pre>
</div>
</div>
</section><section id="clean-it-up-1" class="level2"><h2 class="anchored" data-anchor-id="clean-it-up-1">Clean it up</h2>
<p>We can convert some of the letters to their proper numeric. I intentionally used characters vs numeric on some columns as it “guesses” better in our really low quality image. I then add some logic to convert our numbers if decimal places are missing, and it gets VERY close, but is not perfect.</p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">data_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">win</span><span class="op">:</span><span class="va">leverage</span>, <span class="op">~</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html">tolower</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, <span class="st">"s"</span>, <span class="st">"5"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">win</span><span class="op">:</span><span class="va">leverage</span>, <span class="op">~</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html">tolower</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, <span class="st">"o|a"</span>, <span class="st">"0"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">win</span><span class="op">:</span><span class="va">leverage</span>, <span class="va">as.double</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">win</span><span class="op">:</span><span class="va">leverage</span>, <span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">&gt;</span> <span class="fl">100</span>, <span class="va">.x</span><span class="op">/</span><span class="fl">10</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>lose <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">lose</span> <span class="op">&gt;</span> <span class="va">win</span>, <span class="va">lose</span><span class="op">/</span><span class="fl">10</span>, <span class="va">lose</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>leverage <span class="op">=</span> <span class="va">win</span> <span class="op">-</span> <span class="va">lose</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 25 × 4
   team         win  lose leverage
   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
 1 Bills      100    99.3    0.700
 2 Packers    100   100      0    
 3 Rams       100    98.9    1.10 
 4 Chiefs     100   100      0    
 5 Saints     100   100      0    
 6 Seahawks   100    97.7    2.30 
 7 Steelers   100   100      0    
 8 Buccaneer   99.5  92.6    6.90 
 9 Titans      97.6  18.7   78.9  
10 Colts       94.9  66.4   28.5  
11 Browns      94.6  67.5   27.1  
12 Ravens      90.1  51.8   38.3  
13 Football T  88.6  38.3   50.3  
14 Cardinals   65.7  28.7   37    
15 Dolphins    48.7  13.4   35.3  
16 Giants      41.3  10     31.3  
17 Bears       35.3  18     17.3  
18 Vikings     31.7   4.3   27.4  
19 Raiders     29.1   4.5   24.6  
20 Eagles      18.3   3.4   14.9  
21 49ers       14.5   5      9.5  
22 Patriots    58     0     58    
23 Cowboys     23     0     23    
24 ions        19     0     19    
25 Panthers     1     0      1    </code></pre>
</div>
</div>
<p>It looks really good, and it really only messed up a few rows, which we could fix manually, but you can see that while these techniques are robust you are still at the mercy of image quality!</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target="#callout-1" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Expand for Session Info
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>─ Session info ───────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.1.1 (2021-08-10)
 os       macOS Monterey 12.2.1
 system   aarch64, darwin20
 ui       X11
 language (EN)
 collate  en_US.UTF-8
 ctype    en_US.UTF-8
 tz       America/Chicago
 date     2022-04-25
 pandoc   2.18 @ /Applications/RStudio.app/Contents/MacOS/quarto/bin/tools/ (via rmarkdown)
 quarto   0.9.294 @ /usr/local/bin/quarto

─ Packages ───────────────────────────────────────────────────────────────────
 package     * version date (UTC) lib source
 dplyr       * 1.0.8   2022-02-08 [1] CRAN (R 4.1.1)
 forcats     * 0.5.1   2021-01-27 [1] CRAN (R 4.1.1)
 ggplot2     * 3.3.5   2021-06-25 [1] CRAN (R 4.1.1)
 magick      * 2.7.3   2021-08-18 [1] CRAN (R 4.1.1)
 purrr       * 0.3.4   2020-04-17 [1] CRAN (R 4.1.0)
 readr       * 2.0.2   2021-09-27 [1] CRAN (R 4.1.1)
 sessioninfo * 1.2.2   2021-12-06 [1] CRAN (R 4.1.1)
 stringr     * 1.4.0   2019-02-10 [1] CRAN (R 4.1.1)
 tesseract   * 4.1.2   2021-09-18 [1] CRAN (R 4.1.1)
 tibble      * 3.1.6   2021-11-07 [1] CRAN (R 4.1.1)
 tidyr       * 1.2.0   2022-02-01 [1] CRAN (R 4.1.1)
 tidyverse   * 1.3.1   2021-04-15 [1] CRAN (R 4.1.0)

 [1] /Library/Frameworks/R.framework/Versions/4.1-arm64/Resources/library

──────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
</div>
</div>
</div>
</div>


</section></section></main><!-- /main --><script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><script src="https://utteranc.es/client.js" repo="jthomasmock/themockup-blog" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->



</body></html>